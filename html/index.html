<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>Bubble to Do</title>
  </head>

  <body>
    <!-- <svg width="1600" height="1000"></svg> -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      var w = window,
        d = document,
        e = d.documentElement,
        BODY = d.getElementsByTagName("body")[0];
      var width = w.innerWidth || e.clientWidth || BODY.clientWidth;
      var height = w.innerHeight || e.clientHeight || BODY.clientHeight;

      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("x", 0)
        .attr("y", 0);

      // 1. 描画用のデータ準備
      var width = document.querySelector("svg").clientWidth;
      var height = document.querySelector("svg").clientHeight;
      var nodesData = [];
      var linksData = [];
      var nodeDict = {};

      var dataSet = [
        {
          name: "p1",
          children: [
            { name: "aaa", val: 50 },
            { name: "bbb", val: 50 },
          ],
        },
        {
          name: "p2",
          children: [
            { name: "aaa", val: 50 },
            { name: "bbb", val: 50 },
            { name: "ccc", val: 50 },
            { name: "ddd", val: 50 },
          ],
        },
        {
          name: "p3",
          children: [
            { name: "aaa", val: 50 },
            { name: "bbb", val: 50 },
            { name: "ccc", val: 50 },
            { name: "ddd", val: 50 },
            { name: "eee", val: 50 },
            { name: "fff", val: 50 },
            { name: "g", val: 50 },
            { name: "hhhhh", val: 50 },
            { name: "iiiiiiiiii", val: 50 },
          ],
        },
        {
          name: "p4",
          children: [
            { name: "aaa", val: 50 },
            { name: "bbb", val: 50 },
            { name: "ccc", val: 50 },
            { name: "ddd", val: 50 },
            { name: "eee", val: 50 },
            { name: "fff", val: 50 },
            { name: "g", val: 50 },
            { name: "hhhhh", val: 50 },
            { name: "iiiiiiiiii", val: 50 },
            { name: "iiiiiiiii2", val: 50 },
            { name: "iiiiiiiii3", val: 50 },
          ],
        },
        {
          name: "p5",
          children: [
            { name: "aaa", val: 50 },
            { name: "bbb", val: 50 },
            { name: "ccc", val: 50 },
            { name: "ddd", val: 50 },
            { name: "eee", val: 50 },
            { name: "fff", val: 50 },
            { name: "g", val: 50 },
            { name: "hhhhh", val: 50 },
            { name: "iiiiiiiiii", val: 50 },
            { name: "iiiiiiiii2", val: 50 },
            { name: "iiiiiiiii3", val: 50 },
            { name: "iiiiiiiii4", val: 50 },
          ],
        },
      ];
      var lenChildren = {};
      var max_lenchildren = 0;
      for (parent of dataSet) {
        lenChildren[parent.name] = parent.children.length;
        max_lenchildren = Math.max(max_lenchildren, parent.children.length);
        nodesData.push({
          name: parent.name,
          id: parent.name,
          r: 90 + 25 * Math.round(lenChildren[parent.name] / 3 + 1.5),
          // r: Math.max(30 * lenChildren[parent.name] + 65, 120),
          x: width * (Math.random() * 0.6 + 0.2),
          y: height * (Math.random() * 0.6 + 0.2),
        });
        // console.log(parent.children);
        let c_index = 0;
        for (children of parent.children) {
          // console.log(children);
          nodesData.push({
            name: parent.name + children.name,
            id: parent.name + children.name,
            r: 60,
            parent_name: parent.name,
          });
          linksData.push({
            source: parent.name,
            target: parent.name + children.name,
            l:
              60 +
              25 * ((c_index % Math.round(lenChildren[parent.name] / 3)) + 1),
            // l: 20 * lenChildren[parent.name] * (0.3 + 0.7 * Math.random()),
          });
          c_index++;
        }
      }
      // console.log(nodesData["p4"]);
      // console.log(linksData);
      console.log(lenChildren);

      // 2. svg要素を配置
      // 0. 背景
      d3.select("svg")
        .append("rect")
        .attr("width", "100%")
        .attr("height", "100%")
        .attr("fill", "lightblue");

      var color_scale = d3
        .scaleLinear()
        .domain([0, max_lenchildren])
        .range(["skyblue", "darkblue"]);

      var link = d3
        .select("svg")
        .selectAll("line")
        .data(linksData)
        .enter()
        .append("line")
        .attr("stroke-width", 1)
        .attr("stroke", "black")
        .attr("opacity", 0.0);

      var node = d3
        .select("svg")
        .selectAll("circle")
        .data(nodesData)
        .enter()
        .append("circle")
        .attr("r", function (d) {
          return d.r;
        })
        .attr("fill", function (d) {
          if (d.parent_name == null) {
            return color_scale(lenChildren[d.name]);
          } else {
            console.log(d.parent_name);
            return color_scale(lenChildren[d.parent_name]);
          }
        })
        .attr("stroke", "none")
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        )
        .attr("opacity", function (d) {
          if (d.parent_name == null) {
            return 0.3;
          } else {
            return 0.8;
          }
        });
      // 3. forceSimulation設定
      var simulation = d3
        .forceSimulation()
        .force(
          "link",
          d3
            .forceLink()
            .distance(function (d) {
              return d.l;
            })
            .id(function (d) {
              return d.name;
            })
            .strength(0.3)
            .iterations(16)
        )
        .force(
          "collide",
          d3
            .forceCollide()
            .radius(function (d) {
              return d.r;
            })
            .strength(0.0)

            // .strength(function (d) {
            //   if (d.parent_name == null) {
            //     return 0;
            //   } else {
            //     return 0.7;
            //   }
            // })
            .iterations(16)
        )
        .force("charge", d3.forceManyBody().strength(-200))
        .force(
          "x",
          d3
            .forceX()
            .strength(0.02)
            .x(width / 2)
        )
        .force(
          "y",
          d3
            .forceY()
            .strength(0.02)
            .y(height / 2)
        );

      simulation.nodes(nodesData).on("tick", ticked);

      simulation
        .force("link")
        .links(linksData)
        .id(function (d) {
          return d.name;
        });

      // 4. forceSimulation 描画更新用関数
      function ticked() {
        link
          .attr("x1", function (d) {
            return d.source.x;
          })
          .attr("y1", function (d) {
            return d.source.y;
          })
          .attr("x2", function (d) {
            return d.target.x;
          })
          .attr("y2", function (d) {
            return d.target.y;
          });
        node
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          });
      }

      // 5. ドラッグ時のイベント関数
      function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    </script>
  </body>
</html>
